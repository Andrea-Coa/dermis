{
  "Resources": {
    "MyTestBucket81062430": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": "my-bucket-andrea-demo"
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "StorageStack/MyTestBucket/Resource"
      }
    },
    "MySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow SSH and PostgreSQL",
        "GroupName": "MySecurityGroup",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 22,
            "IpProtocol": "tcp",
            "ToPort": 22
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 5432,
            "IpProtocol": "tcp",
            "ToPort": 5432
          }
        ],
        "VpcId": "vpc-0270a8eed4c1f7d31"
      },
      "Metadata": {
        "aws:cdk:path": "StorageStack/MySecurityGroup"
      }
    },
    "MyEIP": {
      "Type": "AWS::EC2::EIP",
      "Metadata": {
        "aws:cdk:path": "StorageStack/MyEIP"
      }
    },
    "MyEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": "ami-020cba7c55df1f615",
        "InstanceType": "t2.micro",
        "KeyName": "vockey",
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": true,
            "DeviceIndex": "0",
            "GroupSet": [
              {
                "Ref": "MySecurityGroup"
              }
            ],
            "SubnetId": "subnet-07c31b913cff5a843"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "apt-get update -y\n",
                "apt-get install -y postgresql curl\n",
                "\n",
                "# Download init.sql from S3 (creates the DB)\n",
                "curl -o /tmp/init.sql \"https://dermiscreationfiles.s3.amazonaws.com/init.sql?AWSAccessKeyId=ASIA4MAPRFYPL6CXUD6R&Signature=tUVWOTCLDBUwTc0vuv0sSecfAF0%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEEQaCXVzLXdlc3QtMiJHMEUCIQD8VnaDAff2hoFSy5C4zB67Y45zh5%2FuNLvj4KM%2FNf7akgIgfyX5o0yis9X5jlrx7zKCf%2BpYwE0YbPQ8WQyX8IXBFDYqtAIITRABGgw4NTA0MzYxMDc4MDYiDAUJA99VvgoQ6aVTkyqRAqU5kbvBUo%2FCGlVaHCk4EnbLaiyholPOuOSuPMVh3woIhTGxYIjnQ250rRehjHBGbeV9PkiwN2QKDMVxA%2BMh%2FET2W1Ci0biEpEHkg2Gsz8w5%2BnKoBg7nT7pbVJnS%2F8wmbjYsb4CemJQ1Uw%2B2%2FHErqj%2BFethDdO93rN0Y5WCM0r7PoZJ3P2PnV%2FvldQhBZEzgwShQGm2x7sBiHm%2BUOvscfutkdmGGDq6F2pAi98fUFM8tSJz%2BP4g1ScFVRqpuYlj9aFJ9gmnD17UVwAl46p85imR5QDLGr11ntzPsXQdjh9%2FFdlnvQ7hsnIVXxeKzINdcPgQ2zfQIuHbLsGfx%2B%2Fv2yz%2BW%2F%2Bq8mG6tVNlkt3xNIQr0QjDX%2B6XDBjqdAfx%2FZEMx5fvUxMhEsJeY8BwQebPYIhABmiWPcFonbPJgKoHUuxW%2F1Fpcttn0G2FiY1zbcJIUdsJVPW15l49OdzowGt2oOQIAS2PD4SC6gX9%2BgOPonmYLZbuTPfZOBrulgI0ChMlzfN8bfmG4PW0iYiICfG3L68RWV4a6rzU%2Bje6LEEJMTcrAeZxszObf1XSAqoWVk5xoJ8AMHyCG3g8%3D&Expires=1751748219\"\n",
                "sudo -u postgres psql -f /tmp/init.sql\n",
                "\n",
                "# Download schema.sql from S3 (creates tables in the DB)\n",
                "curl -o /tmp/schema.sql \"https://dermiscreationfiles.s3.amazonaws.com/schema.sql?AWSAccessKeyId=ASIA4MAPRFYPL6CXUD6R&Signature=MrfkmUcOAwsCxuhy031k05UC%2FTA%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEEQaCXVzLXdlc3QtMiJHMEUCIQD8VnaDAff2hoFSy5C4zB67Y45zh5%2FuNLvj4KM%2FNf7akgIgfyX5o0yis9X5jlrx7zKCf%2BpYwE0YbPQ8WQyX8IXBFDYqtAIITRABGgw4NTA0MzYxMDc4MDYiDAUJA99VvgoQ6aVTkyqRAqU5kbvBUo%2FCGlVaHCk4EnbLaiyholPOuOSuPMVh3woIhTGxYIjnQ250rRehjHBGbeV9PkiwN2QKDMVxA%2BMh%2FET2W1Ci0biEpEHkg2Gsz8w5%2BnKoBg7nT7pbVJnS%2F8wmbjYsb4CemJQ1Uw%2B2%2FHErqj%2BFethDdO93rN0Y5WCM0r7PoZJ3P2PnV%2FvldQhBZEzgwShQGm2x7sBiHm%2BUOvscfutkdmGGDq6F2pAi98fUFM8tSJz%2BP4g1ScFVRqpuYlj9aFJ9gmnD17UVwAl46p85imR5QDLGr11ntzPsXQdjh9%2FFdlnvQ7hsnIVXxeKzINdcPgQ2zfQIuHbLsGfx%2B%2Fv2yz%2BW%2F%2Bq8mG6tVNlkt3xNIQr0QjDX%2B6XDBjqdAfx%2FZEMx5fvUxMhEsJeY8BwQebPYIhABmiWPcFonbPJgKoHUuxW%2F1Fpcttn0G2FiY1zbcJIUdsJVPW15l49OdzowGt2oOQIAS2PD4SC6gX9%2BgOPonmYLZbuTPfZOBrulgI0ChMlzfN8bfmG4PW0iYiICfG3L68RWV4a6rzU%2Bje6LEEJMTcrAeZxszObf1XSAqoWVk5xoJ8AMHyCG3g8%3D&Expires=1751748219\"\n",
                "sudo -u postgres psql -d dermis_users -f /tmp/schema.sql\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "aws:cdk:path": "StorageStack/MyEC2Instance"
      }
    },
    "EIPAssoc": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MyEIP",
            "AllocationId"
          ]
        },
        "InstanceId": {
          "Ref": "MyEC2Instance"
        }
      },
      "Metadata": {
        "aws:cdk:path": "StorageStack/EIPAssoc"
      }
    },
    "CDKMetadata": {
      "Type": "AWS::CDK::Metadata",
      "Properties": {
        "Analytics": "v2:deflate64:H4sIAAAAAAAA/12NwWrDMBBEvyV7DLKaOj3llril5NKY+GhKkeVNqtiWgnaVYIT/vdhOofQ0MPP2bSrTVSpXC3WnRNdN0ppKxoKVboS601ektYy7oBvkMoIK7F6xRcZDdUHNBBv2AQVUE/GhOoQNLEGAx87dVJu71ugeNlAjsXc9DJ8iO9lZKOaYmTI+JJPgLzbvg0CdypidbIE6eMP9u3fhOmJv+3yMvSVWVuOj2hI5bRQbZ4dBZIHYdUckF7zGEpYwffgt/u25dzdTo98pQrElQi5YnY09jzeHwNfAg8h7/nb2aS2fU/myuJAxiQ+WTYfyOOcPQKjmQVwBAAA="
      },
      "Metadata": {
        "aws:cdk:path": "StorageStack/CDKMetadata/Default"
      }
    }
  },
  "Outputs": {
    "EC2PublicIP": {
      "Value": {
        "Ref": "MyEIP"
      }
    }
  }
}